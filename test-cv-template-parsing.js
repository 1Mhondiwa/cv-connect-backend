// Test script to verify CV template works perfectly with cvParser.js
const CVParser = require('./services/cvParser');
const fs = require('fs');
const path = require('path');

// Sample CV data that would be generated by the CV template
const sampleCVData = {
  firstName: 'John',
  lastName: 'Smith',
  email: 'john.smith@email.com',
  phone: '+1-555-123-4567',
  address: '123 Main Street, New York, NY 10001',
  linkedin: 'https://linkedin.com/in/johnsmith',
  github: 'https://github.com/johnsmith',
  headline: 'Senior Software Developer',
  summary: 'Experienced software developer with 5 years of experience in full-stack development. Skilled in JavaScript, Python, and React. Passionate about creating efficient and scalable web applications.',
  workExperience: [
    {
      title: 'Senior Software Developer',
      company: 'Tech Solutions Inc',
      startDate: 'January 2020',
      endDate: 'Present',
      description: 'Led development of web applications using React and Node.js. Managed a team of 3 developers and improved application performance by 40%.'
    },
    {
      title: 'Software Developer',
      company: 'WebCorp Ltd',
      startDate: 'June 2018',
      endDate: 'December 2019',
      description: 'Developed and maintained web applications using JavaScript and Python. Collaborated with cross-functional teams to deliver high-quality software solutions.'
    }
  ],
  education: [
    {
      degree: 'Bachelor of Science in Computer Science',
      institution: 'University of Technology',
      year: '2018',
      field: 'Computer Science'
    }
  ],
  skills: [
    {
      name: 'JavaScript',
      proficiency: 'Expert',
      yearsExperience: '5'
    },
    {
      name: 'Python',
      proficiency: 'Advanced',
      yearsExperience: '4'
    },
    {
      name: 'React',
      proficiency: 'Advanced',
      yearsExperience: '3'
    },
    {
      name: 'Node.js',
      proficiency: 'Intermediate',
      yearsExperience: '3'
    },
    {
      name: 'SQL',
      proficiency: 'Intermediate',
      yearsExperience: '4'
    }
  ]
};

// Function to generate CV text from template data (simulating the PDF content)
function generateCVText(data) {
  let cvText = '';
  
  // Header
  cvText += `${data.firstName} ${data.lastName}\n`;
  if (data.headline) {
    cvText += `${data.headline}\n`;
  }
  cvText += '\n';
  
  // Contact Information
  cvText += 'Contact Information\n';
  cvText += 'Email: ' + data.email + '\n';
  cvText += 'Phone: ' + data.phone + '\n';
  if (data.address) {
    cvText += 'Address: ' + data.address + '\n';
  }
  if (data.linkedin) {
    cvText += 'LinkedIn: ' + data.linkedin + '\n';
  }
  if (data.github) {
    cvText += 'GitHub: ' + data.github + '\n';
  }
  cvText += '\n';
  
  // Professional Summary
  if (data.summary) {
    cvText += 'Professional Summary\n';
    cvText += data.summary + '\n\n';
  }
  
  // Work Experience
  if (data.workExperience && data.workExperience.length > 0) {
    cvText += 'Work Experience\n';
    data.workExperience.forEach(exp => {
      if (exp.title) {
        cvText += exp.title + '\n';
        if (exp.company) {
          cvText += exp.company + '\n';
        }
        if (exp.startDate || exp.endDate) {
          cvText += `${exp.startDate || ''} - ${exp.endDate || ''}\n`;
        }
        if (exp.description) {
          cvText += exp.description + '\n';
        }
        cvText += '\n';
      }
    });
  }
  
  // Education
  if (data.education && data.education.length > 0) {
    cvText += 'Education\n';
    data.education.forEach(edu => {
      if (edu.degree) {
        cvText += edu.degree + '\n';
        if (edu.institution) {
          cvText += edu.institution + '\n';
        }
        if (edu.year) {
          cvText += edu.year + '\n';
        }
        if (edu.field) {
          cvText += edu.field + '\n';
        }
        cvText += '\n';
      }
    });
  }
  
  // Skills
  if (data.skills && data.skills.length > 0) {
    cvText += 'Skills\n';
    data.skills.forEach(skill => {
      if (skill.name) {
        cvText += `‚Ä¢ ${skill.name}`;
        if (skill.proficiency) {
          cvText += ` - ${skill.proficiency}`;
        }
        if (skill.yearsExperience) {
          cvText += ` - ${skill.yearsExperience} years`;
        }
        cvText += '\n';
      }
    });
  }
  
  return cvText;
}

// Test function to verify parsing accuracy
async function testCVTemplateParsing() {
  console.log('üß™ Testing CV Template with cvParser.js\n');
  
  try {
    // Generate CV text from template data
    const cvText = generateCVText(sampleCVData);
    console.log('üìÑ Generated CV Text:');
    console.log('=' .repeat(50));
    console.log(cvText);
    console.log('=' .repeat(50));
    console.log();
    
    // Create a temporary file for testing
    const tempFilePath = path.join(__dirname, 'temp-cv-test.txt');
    fs.writeFileSync(tempFilePath, cvText, 'utf8');
    
    console.log('üîç Parsing CV with cvParser.js...\n');
    
    // Parse the CV using cvParser.js
    const parsedResult = await CVParser.parseCV(tempFilePath);
    
    // Clean up temporary file
    fs.unlinkSync(tempFilePath);
    
    console.log('‚úÖ Parsing Results:');
    console.log('=' .repeat(50));
    console.log(JSON.stringify(parsedResult, null, 2));
    console.log('=' .repeat(50));
    console.log();
    
    // Verify extraction accuracy
    console.log('üéØ Verification Results:');
    console.log('=' .repeat(50));
    
    const verifications = [
      {
        field: 'First Name',
        expected: sampleCVData.firstName,
        actual: parsedResult.first_name,
        match: sampleCVData.firstName === parsedResult.first_name
      },
      {
        field: 'Last Name',
        expected: sampleCVData.lastName,
        actual: parsedResult.last_name,
        match: sampleCVData.lastName === parsedResult.last_name
      },
      {
        field: 'Email',
        expected: sampleCVData.email,
        actual: parsedResult.email,
        match: sampleCVData.email === parsedResult.email
      },
      {
        field: 'Phone',
        expected: sampleCVData.phone,
        actual: parsedResult.phone,
        match: sampleCVData.phone === parsedResult.phone
      },
      {
        field: 'Address',
        expected: sampleCVData.address,
        actual: parsedResult.address,
        match: sampleCVData.address === parsedResult.address
      },
      {
        field: 'LinkedIn',
        expected: sampleCVData.linkedin,
        actual: parsedResult.linkedin_url,
        match: sampleCVData.linkedin === parsedResult.linkedin_url
      },
      {
        field: 'GitHub',
        expected: sampleCVData.github,
        actual: parsedResult.github_url,
        match: sampleCVData.github === parsedResult.github_url
      },
      {
        field: 'Headline',
        expected: sampleCVData.headline,
        actual: parsedResult.headline,
        match: sampleCVData.headline === parsedResult.headline
      },
      {
        field: 'Summary',
        expected: sampleCVData.summary,
        actual: parsedResult.summary,
        match: sampleCVData.summary === parsedResult.summary
      }
    ];
    
    let totalMatches = 0;
    let totalFields = verifications.length;
    
    verifications.forEach(verification => {
      const status = verification.match ? '‚úÖ' : '‚ùå';
      console.log(`${status} ${verification.field}: ${verification.match ? 'MATCH' : 'MISMATCH'}`);
      if (!verification.match) {
        console.log(`   Expected: "${verification.expected}"`);
        console.log(`   Actual: "${verification.actual}"`);
      }
      if (verification.match) totalMatches++;
    });
    
    console.log();
    console.log(`üìä Overall Accuracy: ${totalMatches}/${totalFields} (${Math.round((totalMatches/totalFields)*100)}%)`);
    
    // Verify work experience
    console.log('\nüíº Work Experience Verification:');
    if (parsedResult.work_experience && parsedResult.work_experience.length > 0) {
      console.log(`‚úÖ Found ${parsedResult.work_experience.length} work experience entries`);
      parsedResult.work_experience.forEach((exp, index) => {
        console.log(`   ${index + 1}. ${exp.title} at ${exp.company || 'Unknown Company'}`);
        console.log(`      Dates: ${exp.start_date || 'Unknown'} - ${exp.end_date || 'Unknown'}`);
      });
    } else {
      console.log('‚ùå No work experience found');
    }
    
    // Verify education
    console.log('\nüéì Education Verification:');
    if (parsedResult.education && parsedResult.education.length > 0) {
      console.log(`‚úÖ Found ${parsedResult.education.length} education entries`);
      parsedResult.education.forEach((edu, index) => {
        console.log(`   ${index + 1}. ${edu.degree}`);
        console.log(`      Institution: ${edu.institution || 'Unknown'}`);
        console.log(`      Year: ${edu.year || 'Unknown'}`);
      });
    } else {
      console.log('‚ùå No education found');
    }
    
    // Verify skills
    console.log('\nüõ†Ô∏è Skills Verification:');
    if (parsedResult.skills && parsedResult.skills.length > 0) {
      console.log(`‚úÖ Found ${parsedResult.skills.length} skills`);
      parsedResult.skills.forEach((skill, index) => {
        console.log(`   ${index + 1}. ${skill.name} (${skill.proficiency || 'Unknown'} level)`);
        if (skill.years_experience) {
          console.log(`      Experience: ${skill.years_experience} years`);
        }
      });
    } else {
      console.log('‚ùå No skills found');
    }
    
    // Verify years of experience
    console.log('\n‚è∞ Years of Experience:');
    console.log(`‚úÖ Calculated: ${parsedResult.years_experience || 0} years`);
    
    console.log('\nüéâ CV Template Test Completed!');
    
    if (totalMatches === totalFields) {
      console.log('üèÜ PERFECT MATCH! The CV template is fully compatible with cvParser.js');
    } else {
      console.log('‚ö†Ô∏è Some fields did not match perfectly. Review the mismatches above.');
    }
    
  } catch (error) {
    console.error('‚ùå Test failed:', error.message);
    console.error(error.stack);
  }
}

// Run the test
if (require.main === module) {
  testCVTemplateParsing();
}

module.exports = {
  testCVTemplateParsing,
  generateCVText,
  sampleCVData
};
